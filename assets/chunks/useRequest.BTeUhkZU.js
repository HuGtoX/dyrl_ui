var I=Object.defineProperty;var V=(n,e,t)=>e in n?I(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var F=(n,e,t)=>V(n,typeof e!="symbol"?e+"":e,t);import{s as P,h as b,at as j,v as Q,x as y,a4 as U,k as p,N as $,as as G,au as X,ar as Y}from"./framework.DZLrHpBd.js";import{i as z,s as J,a as Z,u as k}from"./subscribeFocus.DWRnlB-b.js";import{t as K,j as q}from"./Uint8Array.s5ylH1oV.js";import{t as N}from"./isEqual.TBi3dbYN.js";var C=function(){return K.Date.now()},ee="Expected a function",te=Math.max,ne=Math.min;function W(n,e,t){var s,a,r,i,o,c,f=0,u=!1,l=!1,g=!0;if(typeof n!="function")throw new TypeError(ee);e=N(e)||0,q(t)&&(u=!!t.leading,l="maxWait"in t,r=l?te(N(t.maxWait)||0,e):r,g="trailing"in t?!!t.trailing:g);function d(m){var h=s,T=a;return s=a=void 0,f=m,i=n.apply(T,h),i}function O(m){return f=m,o=setTimeout(A,e),u?d(m):i}function v(m){var h=m-c,T=m-f,x=e-h;return l?ne(x,r-T):x}function E(m){var h=m-c,T=m-f;return c===void 0||h>=e||h<0||l&&T>=r}function A(){var m=C();if(E(m))return w(m);o=setTimeout(A,v(m))}function w(m){return o=void 0,g&&s?d(m):(s=a=void 0,i)}function R(){o!==void 0&&clearTimeout(o),f=0,s=c=a=o=void 0}function _(){return o===void 0?i:w(C())}function S(){var m=C(),h=E(m);if(s=arguments,a=this,c=m,h){if(o===void 0)return O(c);if(l)return clearTimeout(o),o=setTimeout(A,e),d(c)}return o===void 0&&(o=setTimeout(A,e)),i}return S.cancel=R,S.flush=_,S}var se="Expected a function";function ie(n,e,t){var s=!0,a=!0;if(typeof n!="function")throw new TypeError(se);return q(t)&&(s="leading"in t?!!t.leading:s,a="trailing"in t?!!t.trailing:a),W(n,e,{leading:s,maxWait:e,trailing:a})}function re(n=!1,e){const t=P(n),s=b(()=>{const a=!n;return{toggle:()=>{t.value=t.value===n?a:n},set:f=>t.value=f,setLeft:()=>t.value=n,setRight:()=>t.value=a}});return[j(t),{...s.value}]}function ae(n=!1){const[e,{set:t,toggle:s}]=re(n);return[e,{set:r=>t(!!r),setTrue:()=>t(!0),setFalse:()=>t(!1),toggle:s}]}const Be=(n,e={})=>{const{isNoMore:t,reloadDeps:s=[],manual:a,onBefore:r,onSuccess:i,onError:o,onFinally:c}=e,f=P(),[u,{set:l}]=ae(),g=h=>{f.value=h},d=b(()=>t?t(f.value):!1),{loading:O,run:v,runAsync:E,cancel:A}=De(async h=>{const T=await n(h);return h?f.value={...T,list:[...h.list,...T.list]}:f.value=T,T},{manual:a,onFinally:(h,T,x)=>{l(!1),c==null||c(T,x)},onBefore:()=>r==null?void 0:r(),onSuccess:h=>i==null?void 0:i(h),onError:h=>o==null?void 0:o(h)}),w=()=>{d.value||(l(!0),v(f.value))},R=()=>{if(!d.value)return l(!0),E(f.value)},_=()=>{v()},S=()=>E();Q(s,()=>{v()});const m=b(()=>u.value||O.value);return{data:j(f),loading:m,loadingMore:u,noMore:d,loadMore:w,loadMoreAsync:R,reload:_,reloadAsync:S,mutate:g,cancel:A}},B=new Map,oe=(n,e,t)=>{const s=B.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let a;e>-1&&(a=setTimeout(()=>{B.delete(n)},e)),B.set(n,{...t,timer:a})},ue=n=>B.get(n),M=new Map,le=n=>M.get(n),ce=(n,e)=>{M.set(n,e),e.then(t=>(M.delete(n),t)).catch(t=>{throw M.delete(n),t})},D={},fe=[],de=(n,e)=>{D[n]&&(D[n].forEach(t=>t(e)),fe.forEach(t=>t({type:n,data:e})))},L=(n,e)=>(D[n]||(D[n]=[]),D[n].push(e),function(){const s=D[n].indexOf(e);D[n].splice(s,1)}),ve=(n,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:s=0,setCache:a,getCache:r})=>{const i=P(),o=P(),c=(u,l)=>{a?a(l):oe(u,t,l),de(u,l.data)},f=(u,l=[])=>r?r(l):ue(u);return y(()=>{if(!e)return;const u=f(e);u&&Object.hasOwnProperty.call(u,"data")&&(n.state.data=u.data,n.state.params=u.params,(s===-1||new Date().getTime()-u.time<=s)&&(n.state.loading=!1)),i.value=L(e,l=>{n.setState({data:l})})}),U(()=>{var u;(u=i.value)==null||u.call(i)}),e?{name:"cachePlugin",onBefore:u=>{const l=f(e,u);return!l||!Object.hasOwnProperty.call(l,"data")?{}:s===-1||new Date().getTime()-l.time<=s?{loading:!1,data:l==null?void 0:l.data,returnNow:!0}:{data:l==null?void 0:l.data}},onRequest:(u,l)=>{let g=le(e);return g&&g!==o.value?{servicePromise:g}:(g=u(...l),o.value=g,ce(e,g),{servicePromise:g})},onSuccess:(u,l)=>{var g;e&&((g=i.value)==null||g.call(i),c(e,{data:u,params:l,time:new Date().getTime()}),i.value=L(e,d=>{n.setState({data:d})}))},onMutate:u=>{var l;e&&((l=i.value)==null||l.call(i),c(e,{data:u,params:n.state.params,time:new Date().getTime()}),i.value=L(e,g=>{n.setState({data:g})}))}}:{}},ge=(n,{debounceWait:e,debounceLeading:t,debounceTrailing:s,debounceMaxWait:a})=>{const r=P(),i=b(()=>{const o={},c=p(t),f=p(s),u=p(a);return c!==void 0&&(o.leading=c),f!==void 0&&(o.trailing=f),u!==void 0&&(o.maxWait=u),o});return y(o=>{if(p(e)){const c=n.runAsync.bind(n);r.value=W(f=>{f()},p(e),i.value),n.runAsync=(...f)=>new Promise((u,l)=>{var g;(g=r.value)==null||g.call(r,()=>{c(...f).then(u).catch(l)})}),o(()=>{var f;(f=r.value)==null||f.cancel(),n.runAsync=c})}}),p(e)?{name:"debouncePlugin",onCancel:()=>{var o;(o=r.value)==null||o.cancel()}}:{}},me=(n,{loadingDelay:e})=>{const t=P();if(!p(e))return{};const s=()=>{t.value&&clearTimeout(t.value)};return{name:"loadingDelayPlugin",onBefore:()=>(s(),t.value=setTimeout(()=>{n.setState({loading:!0})},p(e)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},he=(n,{pollingInterval:e,pollingWhenHidden:t=!0,pollingErrorRetryCount:s=-1})=>{const a=P(),r=P(),i=P(0),o=()=>{var c;a.value&&clearInterval(a.value),(c=r.value)==null||c.call(r)};return y(()=>{p(e)||o()}),p(e)?{name:"pollingPlugin",onBefore:()=>{o()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{s===-1||s!==-1&&i.value<=s?a.value=setTimeout(()=>{!t&&!z()?r.value=J(()=>{n.refresh()}):n.refresh()},p(e)):i.value=0},onCancel:()=>{o()}}:{}};function pe(n,e){let t=!1;return(...s)=>{t||(t=!0,n(...s),setTimeout(()=>{t=!1},e))}}const Pe=(n,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const s=P(),a=()=>{var r;(r=s.value)==null||r.call(s)};return y(r=>{if(p(e)){const i=pe(n.refresh.bind(n),p(t));s.value=Z(()=>{i()})}r(()=>{a()})}),U(()=>{a()}),{name:"refreshOnWindowFocusPlugin"}},Ee=(n,{retryInterval:e,retryCount:t})=>{const s=P(),a=P(0),r=P(!1);return t?{name:"retryPlugin",onBefore:()=>{r.value||(a.value=0),r.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,t===-1||a.value<=t){const i=e??Math.min(1e3*2**a.value,3e4);s.value=setTimeout(()=>{r.value=!0,n.refresh()},i)}else a.value=0},onCancel:()=>{a.value=0,s.value&&clearTimeout(s.value)}}:{}},Te=(n,{throttleWait:e,throttleLeading:t,throttleTrailing:s})=>{const a=b(()=>{const i={};return p(t)!==void 0&&(i.leading=p(t)),p(s)!==void 0&&(i.trailing=p(s)),i}),r=b(()=>ie(i=>{i()},p(e),a.value));return y(i=>{if(p(e)){const o=n.runAsync.bind(n);n.runAsync=(...c)=>new Promise((f,u)=>{var l;(l=r.value)==null||l.call(r,()=>{o(...c).then(f).catch(u)})}),i(()=>{var c;n.runAsync=o,(c=r.value)==null||c.cancel()})}}),p(e)?{name:"throttlePlugin",onCancel:()=>{var i;(i=r.value)==null||i.cancel()}}:{}},H=n=>typeof n=="function",Re=n=>typeof n=="boolean";class Oe{constructor(e,t,s,a={}){F(this,"pluginImpls");F(this,"count",0);F(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});F(this,"previousValidData");this.serviceRef=e,this.options=t,this.setUpdateData=s,this.initState=a,this.state={...this.state,loading:!t.manual,...a}}setState(e={}){this.state={...this.state,...e},this.setUpdateData(this.state)}setData(e,t){console.warn("Please use 'setFetchState' instead of 'setData'"),t instanceof Array?t.forEach(s=>{this.state[s]=e,this.setUpdateData(e,s)}):(this.state[t]=e,this.setUpdateData(e,t))}setFetchState(e,t){t instanceof Array?t.forEach(s=>{this.state[s]=e,this.setUpdateData(e,s)}):(this.state[t]=e,this.setUpdateData(e,t))}runPluginHandler(e,...t){var a,r;const s=(r=((a=this.pluginImpls)==null?void 0:a.map(i=>{var o;return(o=i[e])==null?void 0:o.call(i,...t)}))??[])==null?void 0:r.filter(Boolean);return Object.assign({},...s)}async runAsync(...e){var i,o,c,f,u,l,g,d,O;this.count+=1;const t=this.count,{stopNow:s=!1,returnNow:a=!1,...r}=this.runPluginHandler("onBefore",e);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...r}),a)return Promise.resolve(r.data);(o=(i=this.options).onBefore)==null||o.call(i,e);try{let{servicePromise:v}=this.runPluginHandler("onRequest",this.serviceRef.value,e);const E=w=>{var _,S,m,h;if(t!==this.count)return new Promise(()=>{});const R=this.options.formatResult?this.options.formatResult(w):w;return this.setState({data:R,error:void 0,loading:!1}),(S=(_=this.options).onSuccess)==null||S.call(_,R,e),this.runPluginHandler("onSuccess",R,e),this.previousValidData=R,(h=(m=this.options).onFinally)==null||h.call(m,e,R,void 0),t===this.count&&this.runPluginHandler("onFinally",e,R,void 0),R};v||(v=this.serviceRef.value(...e));const A=await v;return E(A)}catch(v){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:v,loading:!1}),(f=(c=this.options).onError)==null||f.call(c,v,e),this.runPluginHandler("onError",v,e),(H((u=this.options)==null?void 0:u.rollbackOnError)&&((l=this.options)!=null&&l.rollbackOnError(e))||Re((g=this.options)==null?void 0:g.rollbackOnError)&&this.options.rollbackOnError)&&this.setState({data:this.previousValidData}),(O=(d=this.options).onFinally)==null||O.call(d,e,void 0,v),t===this.count&&this.runPluginHandler("onFinally",e,void 0,v),v}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){const t=H(e)?e(this.state.data):e;this.runPluginHandler("onMutate",t),this.setState({data:t})}}const Ae=Symbol("USEREQUEST_GLOBAL_OPTIONS_PROVIDE_KEY");function Se(n){return Object.keys(n).filter(t=>["data","loading","params","error"].includes(t)).length===4}function we(n,e={},t=[]){const s=$(Ae,{}),{initialData:a=void 0,manual:r=!1,ready:i=!0,...o}={...s??{},...e??{}},c={manual:r,ready:i,...o},f=P(n),u=G({data:a,loading:!1,params:void 0,error:void 0}),l=(v,E)=>{E?u[E]=v:Se(v)&&(u.data=v.data,u.loading=v.loading,u.error=v.error,u.params=v.params)},g=t.map(v=>{var E;return(E=v==null?void 0:v.onInit)==null?void 0:E.call(v,c)}).filter(Boolean),d=new Oe(f,c,l,Object.assign({},...g,u));d.options=c,d.pluginImpls=t.map(v=>v(d,c));const O=b(()=>Y(i)?i.value:i);if(y(()=>{if(!r){const v=d.state.params||e.defaultParams||[];O.value&&d.options.refreshDeps===!0&&f.value&&d.run(...v)}}),!r&&d.options.refreshDeps!==!0){const v=d.state.params||e.defaultParams||[];p(i)&&d.run(...v)}return U(()=>{d.cancel()}),{...X(u),cancel:d.cancel.bind(d),refresh:d.refresh.bind(d),refreshAsync:d.refreshAsync.bind(d),run:d.run.bind(d),runAsync:d.runAsync.bind(d),mutate:d.mutate.bind(d)}}function De(n,e,t){const s=[ge,me,he,Pe,Te,k,ve,Ee].filter(Boolean);return we(n,e,[...s])}export{Be as u};
